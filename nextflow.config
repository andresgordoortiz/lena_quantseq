// Profile config for CLIP cluster
params {
    config_profile_description = 'CLIP cluster profile'
    config_profile_contact = 'Andres Ortiz'
}

if (System.getenv("SLURM_CONF")) {
    process {
        executor = 'slurm'
        queue    = 'c'  // Default compute partition
    }
} else {
    process {
        executor = 'local'
    }
}

singularity {
    enabled = true
    autoMounts = true
}

// Global process configuration
process {
    // Default error handling with retries
    errorStrategy = { task.exitStatus in [1, 135, 255, 143, 137, 104, 134, 139] ? 'retry' : 'finish' }
    maxRetries    = 3
    
    // Scale resources on retry
    memory = { task.memory ? task.memory * task.attempt : 12.GB * task.attempt }
    cpus = { task.cpus ? task.cpus * Math.min(task.attempt, 2) : 1 }
    
    // Exponential backoff between retries
    backOffStrategy = 'exponential'
    
    // Default QoS based on queue - SIMPLIFIED VERSION
    clusterOptions = { 
        task.queue == 'c' ? '--qos=c_short' : 
        task.queue == 'g' ? '--qos=g_short' : 
        task.queue == 'm' ? '--qos=m_short' : 
        '--qos=c_short' 
    }
    
    // GPU partition processes
    withLabel: 'gpu' {
        queue = 'g'
        clusterOptions = '--gres=gpu:1 --qos=g_short'
    }
    
    // High-memory partition processes
    withLabel: 'highmem' {
        queue = 'm'
        clusterOptions = '--qos=m_short'
    }
}